@model DiversityPub.Models.Activation
@{
    ViewData["Title"] = "Modifier l'Activation";
}

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-edit"></i> Modifier l'Activation
                </h4>
            </div>
            <div class="card-body">
                <form asp-action="Edit" method="post">
                    <input type="hidden" asp-for="Id" />
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="Nom" class="form-label">
                                    <i class="fas fa-map-marker-alt"></i> Nom de l'activation
                                </label>
                                <input asp-for="Nom" class="form-control" required />
                                <span asp-validation-for="Nom" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="CampagneId" class="form-label">
                                    <i class="fas fa-bullhorn"></i> Campagne
                                </label>
                                <select asp-for="CampagneId" class="form-select" required id="CampagneId">
                                    <option value="">Sélectionner une campagne</option>
                                    @foreach (var campagne in ViewBag.Campagnes)
                                    {
                                        if (campagne.Id == Model.CampagneId)
                                        {
                                            <option value="@campagne.Id" selected
                                                    data-date-debut="@campagne.DateDebut.ToString("yyyy-MM-dd")" 
                                                    data-date-fin="@campagne.DateFin.ToString("yyyy-MM-dd")">
                                                @campagne.Nom (@campagne.DateDebut.ToString("dd/MM/yyyy") - @campagne.DateFin.ToString("dd/MM/yyyy"))
                                            </option>
                                        }
                                        else
                                        {
                                            <option value="@campagne.Id"
                                                    data-date-debut="@campagne.DateDebut.ToString("yyyy-MM-dd")" 
                                                    data-date-fin="@campagne.DateFin.ToString("yyyy-MM-dd")">
                                                @campagne.Nom (@campagne.DateDebut.ToString("dd/MM/yyyy") - @campagne.DateFin.ToString("dd/MM/yyyy"))
                                            </option>
                                        }
                                    }
                                </select>
                                <span asp-validation-for="CampagneId" class="text-danger"></span>
                                <div id="campagne-date-info" class="alert alert-info mt-2" style="display: none;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Description" class="form-label">
                            <i class="fas fa-align-left"></i> Description
                        </label>
                        <textarea asp-for="Description" class="form-control" rows="3" 
                                  placeholder="Décrivez les objectifs de cette activation...">@Model.Description</textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="DateActivation" class="form-label">
                                    <i class="fas fa-calendar"></i> Date d'activation
                                </label>
                                <input asp-for="DateActivation" type="date" class="form-control" required />
                                <span asp-validation-for="DateActivation" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="LieuId" class="form-label">
                                    <i class="fas fa-map-marker-alt"></i> Lieu
                                </label>
                                <select asp-for="LieuId" class="form-select" required>
                                    <option value="">Sélectionner un lieu</option>
                                    @foreach (var lieu in ViewBag.Lieux)
                                    {
                                        if (lieu.Id == Model.LieuId)
                                        {
                                            <option value="@lieu.Id" selected>@lieu.Nom</option>
                                        }
                                        else
                                        {
                                            <option value="@lieu.Id">@lieu.Nom</option>
                                        }
                                    }
                                </select>
                                <span asp-validation-for="LieuId" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="HeureDebut" class="form-label">
                                    <i class="fas fa-clock"></i> Heure de début
                                </label>
                                <input asp-for="HeureDebut" type="time" class="form-control" required />
                                <span asp-validation-for="HeureDebut" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="HeureFin" class="form-label">
                                    <i class="fas fa-clock"></i> Heure de fin
                                </label>
                                <input asp-for="HeureFin" type="time" class="form-control" required />
                                <span asp-validation-for="HeureFin" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Instructions" class="form-label">
                            <i class="fas fa-list-check"></i> Instructions
                        </label>
                        <textarea asp-for="Instructions" class="form-control" rows="4" 
                                  placeholder="Donnez les instructions détaillées pour cette activation...">@Model.Instructions</textarea>
                        <span asp-validation-for="Instructions" class="text-danger"></span>
                    </div>

                                         <div class="mb-3">
                         <label class="form-label">
                             <i class="fas fa-users"></i> Agents Terrain Disponibles
                         </label>
                         <div id="agents-container">
                             @if (ViewBag.AgentsTerrain != null && ((IEnumerable<DiversityPub.Models.AgentTerrain>)ViewBag.AgentsTerrain).Any())
                             {
                                 <div class="row">
                                     @foreach (var agent in ViewBag.AgentsTerrain)
                                     {
                                         var isSelected = Model.AgentsTerrain?.Any(at => at.Id == agent.Id) ?? false;
                                         <div class="col-md-4 mb-2">
                                             <div class="form-check">
                                                 <input class="form-check-input agent-checkbox" type="checkbox" name="agentIds" 
                                                        value="@agent.Id" id="agent_@agent.Id" @(isSelected ? "checked" : "") data-agent-name="@agent.Utilisateur.Prenom @agent.Utilisateur.Nom" />
                                                 <label class="form-check-label" for="agent_@agent.Id">
                                                     @agent.Utilisateur.Prenom @agent.Utilisateur.Nom
                                                 </label>
                                             </div>
                                         </div>
                                     }
                                 </div>
                                 <small class="text-muted">Sélectionnez les agents disponibles qui participeront à cette activation (optionnel)</small>
                             }
                             else
                             {
                                 <div class="alert alert-info">
                                     <i class="fas fa-info-circle"></i> Aucun agent terrain disponible pour le moment. 
                                     Vous pouvez modifier l'activation sans agent et en ajouter plus tard.
                                 </div>
                             }
                         </div>
                     </div>

                    <div class="mb-3">
                        <label asp-for="Statut" class="form-label">
                            <i class="fas fa-tasks"></i> Statut
                        </label>
                        <select asp-for="Statut" class="form-select" required id="statutSelect">
                            <option value="@DiversityPub.Models.enums.StatutActivation.Planifiee">Planifiée</option>
                            <option value="@DiversityPub.Models.enums.StatutActivation.EnCours">En Cours</option>
                            <option value="@DiversityPub.Models.enums.StatutActivation.Suspendue">Suspendue</option>
                            <option value="@DiversityPub.Models.enums.StatutActivation.Terminee">Terminée</option>
                        </select>
                        <span asp-validation-for="Statut" class="text-danger"></span>
                        <div id="statutWarning" class="alert alert-warning mt-2" style="display: none;">
                            <i class="fas fa-exclamation-triangle"></i> 
                            <strong>Attention :</strong> <span id="statutWarningText"></span>
                        </div>
                        <div id="agentsWarning" class="alert alert-danger mt-2" style="display: none;">
                            <i class="fas fa-exclamation-triangle"></i> 
                            <strong>Erreur :</strong> <span id="agentsWarningText"></span>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="@Url.Action("Index", "Activation")" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Retour
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Enregistrer les modifications
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        // Validation des heures et de la date d'activation
        document.addEventListener('DOMContentLoaded', function() {
            const heureDebut = document.getElementById('HeureDebut');
            const heureFin = document.getElementById('HeureFin');
            const dateActivation = document.getElementById('DateActivation');
            const campagneSelect = document.getElementById('CampagneId');
            
            // Définir la date minimale à aujourd'hui
            const today = new Date().toISOString().split('T')[0];
            dateActivation.min = today;
            
            // Validation de l'heure de fin
            heureFin.addEventListener('change', function() {
                if (heureDebut.value && this.value && this.value <= heureDebut.value) {
                    alert('L\'heure de fin doit être postérieure à l\'heure de début.');
                    this.value = '';
                }
            });
            
            // Validation de l'heure de début
            heureDebut.addEventListener('change', function() {
                if (heureFin.value && this.value && this.value >= heureFin.value) {
                    alert('L\'heure de début doit être antérieure à l\'heure de fin.');
                    heureFin.value = '';
                }
            });
            
            // Validation de la date d'activation par rapport à la campagne
            campagneSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption && selectedOption.dataset.dateDebut && selectedOption.dataset.dateFin) {
                    const dateDebut = selectedOption.dataset.dateDebut;
                    const dateFin = selectedOption.dataset.dateFin;
                    
                    dateActivation.min = dateDebut;
                    dateActivation.max = dateFin;
                    
                    // Afficher un message informatif
                    const infoDiv = document.getElementById('campagne-date-info');
                    if (infoDiv) {
                        infoDiv.innerHTML = `<i class="fas fa-info-circle"></i> La date d'activation doit être comprise entre ${dateDebut} et ${dateFin}`;
                        infoDiv.style.display = 'block';
                    }
                }
            });
            
                         // Fonction pour mettre à jour la liste des agents disponibles
             async function updateAgentsDisponibles(date) {
                 try {
                     const activationId = '@Model.Id';
                     const response = await fetch(`/Activation/GetAgentsDisponibles?date=${date.toISOString().split('T')[0]}&activationId=${activationId}`);
                     const data = await response.json();
                     
                     const agentsContainer = document.getElementById('agents-container');
                     
                     if (data.success) {
                         if (data.agents.length > 0) {
                             let html = '<div class="row">';
                             data.agents.forEach(agent => {
                                 // Vérifier si l'agent était déjà sélectionné
                                 const wasSelected = document.querySelector(`input[value="${agent.Id}"]`)?.checked || false;
                                 const checkedAttr = wasSelected ? 'checked' : '';
                                 
                                 html += `
                                     <div class="col-md-4 mb-2">
                                         <div class="form-check">
                                             <input class="form-check-input agent-checkbox" type="checkbox" name="agentIds" 
                                                    value="${agent.Id}" id="agent_${agent.Id}" ${checkedAttr} data-agent-name="${agent.Nom}" />
                                             <label class="form-check-label" for="agent_${agent.Id}">
                                                 ${agent.Nom}
                                             </label>
                                         </div>
                                     </div>
                                 `;
                             });
                             html += '</div>';
                             html += '<small class="text-muted">Sélectionnez les agents disponibles qui participeront à cette activation (optionnel)</small>';
                             
                             agentsContainer.innerHTML = html;
                         } else {
                             agentsContainer.innerHTML = `
                                 <div class="alert alert-warning">
                                     <i class="fas fa-exclamation-triangle"></i> Aucun agent disponible pour cette date. 
                                     Tous les agents sont déjà affectés à d'autres activations.
                                 </div>
                             `;
                         }
                     } else {
                         console.error('Erreur lors de la récupération des agents:', data.message);
                     }
                 } catch (error) {
                     console.error('Erreur lors de la mise à jour des agents:', error);
                 }
             }
             
                           // Mettre à jour les agents quand la date change
              dateActivation.addEventListener('change', function() {
                  if (this.value) {
                      updateAgentsDisponibles(new Date(this.value));
                  } else {
                      // Afficher le message initial si aucune date n'est sélectionnée
                      const agentsContainer = document.getElementById('agents-container');
                      agentsContainer.innerHTML = `
                          <div class="alert alert-info">
                              <i class="fas fa-info-circle"></i> Veuillez sélectionner une date d'activation pour voir les agents disponibles.
                          </div>
                      `;
                  }
              });
              
              // Mettre à jour les agents au chargement si une date est déjà sélectionnée
              if (dateActivation.value) {
                  updateAgentsDisponibles(new Date(dateActivation.value));
              } else {
                  // Afficher le message initial si aucune date n'est sélectionnée
                  const agentsContainer = document.getElementById('agents-container');
                  agentsContainer.innerHTML = `
                      <div class="alert alert-info">
                          <i class="fas fa-info-circle"></i> Veuillez sélectionner une date d'activation pour voir les agents disponibles.
                      </div>
                  `;
              }
             
             // Déclencher la validation au chargement si une campagne est déjà sélectionnée
             if (campagneSelect.value) {
                 campagneSelect.dispatchEvent(new Event('change'));
             }
             
             // Validation des transitions de statut
             const statutSelect = document.getElementById('statutSelect');
             const statutWarning = document.getElementById('statutWarning');
             const statutWarningText = document.getElementById('statutWarningText');
             const agentsWarning = document.getElementById('agentsWarning');
             const agentsWarningText = document.getElementById('agentsWarningText');
             const currentStatut = '@Model.Statut';
             
             statutSelect.addEventListener('change', function() {
                 const newStatut = this.value;
                 
                 // Règles de transition
                 const transitions = {
                     '@DiversityPub.Models.enums.StatutActivation.Planifiee': ['@DiversityPub.Models.enums.StatutActivation.EnCours', '@DiversityPub.Models.enums.StatutActivation.Suspendue', '@DiversityPub.Models.enums.StatutActivation.Terminee'],
                     '@DiversityPub.Models.enums.StatutActivation.EnCours': ['@DiversityPub.Models.enums.StatutActivation.Suspendue', '@DiversityPub.Models.enums.StatutActivation.Terminee'],
                     '@DiversityPub.Models.enums.StatutActivation.Suspendue': ['@DiversityPub.Models.enums.StatutActivation.EnCours', '@DiversityPub.Models.enums.StatutActivation.Terminee'],
                     '@DiversityPub.Models.enums.StatutActivation.Terminee': []
                 };
                 
                 const allowedTransitions = transitions[currentStatut] || [];
                 
                 if (!allowedTransitions.includes(newStatut)) {
                     let warningMessage = '';
                     switch (currentStatut) {
                         case '@DiversityPub.Models.enums.StatutActivation.EnCours':
                             warningMessage = 'Une activation en cours ne peut pas revenir au statut "Planifiée".';
                             break;
                         case '@DiversityPub.Models.enums.StatutActivation.Terminee':
                             warningMessage = 'Une activation terminée ne peut plus changer de statut.';
                             break;
                         case '@DiversityPub.Models.enums.StatutActivation.Suspendue':
                             warningMessage = 'Une activation suspendue ne peut pas revenir au statut "Planifiée".';
                             break;
                         default:
                             warningMessage = `Transition non autorisée depuis le statut "${currentStatut}".`;
                     }
                     
                     statutWarningText.textContent = warningMessage;
                     statutWarning.style.display = 'block';
                     
                     // Remettre l'ancienne valeur
                     this.value = currentStatut;
                     return false;
                 } else {
                     statutWarning.style.display = 'none';
                 }
             
                 // Validation des agents terrain pour le statut "En Cours"
                 const agentCheckboxes = document.querySelectorAll('.agent-checkbox');
                 const selectedAgents = Array.from(agentCheckboxes).filter(cb => cb.checked);
                 
                 if (newStatut === '@DiversityPub.Models.enums.StatutActivation.EnCours' && selectedAgents.length === 0) {
                     agentsWarningText.textContent = 'Impossible de démarrer une activation sans agent terrain. Veuillez assigner au moins un agent.';
                     agentsWarning.style.display = 'block';
                     
                     // Remettre l'ancienne valeur
                     this.value = currentStatut;
                     return false;
                 } else {
                     agentsWarning.style.display = 'none';
                 }
             });
        });
    </script>
} 